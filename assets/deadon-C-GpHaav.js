var l=Object.defineProperty;var u=(n,t,r)=>t in n?l(n,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):n[t]=r;var i=(n,t,r)=>u(n,typeof t!="symbol"?t+"":t,r);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))h(e);new MutationObserver(e=>{for(const s of e)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&h(o)}).observe(document,{childList:!0,subtree:!0});function r(e){const s={};return e.integrity&&(s.integrity=e.integrity),e.referrerPolicy&&(s.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?s.credentials="include":e.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function h(e){if(e.ep)return;e.ep=!0;const s=r(e);fetch(e.href,s)}})();class f{constructor(t={}){i(this,"_bpm");i(this,"_ppqn");i(this,"lookahead");i(this,"interval");i(this,"tickIntervalMs");i(this,"startPerf",0);i(this,"nextTickPerf",0);i(this,"tickCount",0);i(this,"running",!1);i(this,"scheduledEvents",[]);i(this,"listeners",{tick:new Set});i(this,"audioContext");i(this,"startAudioTime",0);i(this,"startPerfTime",0);i(this,"lastEmittedTick",-1);this._bpm=t.bpm??120,this._ppqn=t.ppqn??24,this.lookahead=t.lookahead??50,this.interval=t.interval??20,this.audioContext=t.audioContext,this.tickIntervalMs=6e4/this._bpm/this._ppqn}get bpm(){return this._bpm}get ppqn(){return this._ppqn}get started(){return this.running}on(t,r){this.listeners[t].add(r)}off(t,r){this.listeners[t].delete(r)}start(){this.running||(this.running=!0,this.tickCount=0,this.startPerf=performance.now(),this.startPerfTime=this.startPerf,this.audioContext?this.startAudioTime=this.audioContext.currentTime:this.startAudioTime=0,this.nextTickPerf=this.startPerf,this.schedule())}stop(){this.running=!1}setBpm(t){this._bpm=t,this.tickIntervalMs=6e4/this._bpm/this._ppqn}setPpqn(t){this._ppqn=t,this.tickIntervalMs=6e4/this._bpm/this._ppqn}scheduleAt(t,r){this.scheduledEvents.push({timeMs:r,callback:t}),this.scheduledEvents.sort((h,e)=>h.timeMs-e.timeMs)}schedule(){if(!this.running)return;const t=performance.now(),r=t+this.lookahead;for(;this.nextTickPerf<=r;){const s=this.nextTickPerf,o=this.tickCount++;if(o!==this.lastEmittedTick){for(const c of this.listeners.tick){const a=this.audioContext?this.startAudioTime+(s-this.startPerfTime)/1e3:s/1e3;c({audioTime:a,timeMs:s,tick:o,bpm:this.bpm,ppqn:this.ppqn})}this.lastEmittedTick=o}this.nextTickPerf+=this.tickIntervalMs}for(;this.scheduledEvents.length&&this.scheduledEvents[0].timeMs<=r;)this.scheduledEvents.shift().callback();const h=performance.now()-t,e=Math.max(0,this.interval-h);setTimeout(()=>this.schedule(),e)}}export{f as D};
