var F=Object.defineProperty;var G=(l,t,e)=>t in l?F(l,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):l[t]=e;var p=(l,t,e)=>G(l,typeof t!="symbol"?t+"":t,e);import{D as B}from"./deadon-Dd8uKvdJ.js";class b{constructor(t,e=16,s,a){p(this,"sequence");p(this,"schedule",new Map);p(this,"barTicks");p(this,"effectiveBarTicks");p(this,"ticksPerStep");p(this,"secPerTick");p(this,"bpm",120);p(this,"ppqn",24);p(this,"division",1);this.clock=t,this.steps=e,this.ppqn=s??t.ppqn,this.bpm=a??t.bpm,this.barTicks=this.ppqn*4,this.effectiveBarTicks=this.barTicks/this.division,this.secPerTick=60/(this.bpm*this.ppqn),this.ticksPerStep=this.effectiveBarTicks/this.steps,this.sequence=Array(this.steps).fill(null),this.rebuildSchedule()}setSequence(t){if(t.length!==this.steps)throw new Error(`Sequence length must be ${this.steps}`);this.sequence=t.slice(),this.rebuildSchedule()}setStep(t,e){if(t<0||t>=this.steps)throw new Error(`Step must be between 0 and ${this.steps-1}`);this.sequence[t]=e,this.rebuildSchedule()}clearSequence(){this.sequence.fill(null),this.rebuildSchedule()}setPpqn(t){this.ppqn=t,this.barTicks=this.ppqn*4,this.effectiveBarTicks=this.barTicks/this.division,this.ticksPerStep=this.effectiveBarTicks/this.steps,this.secPerTick=60/(this.bpm*this.ppqn),this.rebuildSchedule()}setBpm(t){this.bpm=t,this.secPerTick=60/(this.bpm*this.ppqn),this.effectiveBarTicks=this.barTicks/this.division,this.ticksPerStep=this.effectiveBarTicks/this.steps,this.rebuildSchedule()}setDivision(t){this.division=Math.max(1,Math.floor(t)),this.effectiveBarTicks=this.barTicks/this.division,this.ticksPerStep=this.effectiveBarTicks/this.steps,this.rebuildSchedule()}clearStep(t){this.setStep(t,null)}getPayloadsForTick(t){return this.schedule.get(t%this.effectiveBarTicks)??[]}rebuildSchedule(){this.schedule.clear();for(let t=0;t<this.steps;t++){const e=this.sequence[t];if(!e)continue;let s=(t+1)%this.steps;for(;s!==t&&!this.sequence[s];)s=(s+1)%this.steps;const a=s===t?this.steps:s>t?s-t:s+this.steps-t,u=e.subdivs??0,S=this.secPerTick*1e3,v=e.offsetMs!=null?Math.round(e.offsetMs/S):0;if(u===0){const d=Math.floor(t*this.ticksPerStep)+v;for(const o of e.payload)this.pushPayloadAt(d,o);continue}const T=a*u;for(let h=0;h<T;h++){const d=Math.floor(h/u),o=h%u,n=(t+d)%this.steps,f=Math.floor(n*this.ticksPerStep)+Math.floor(o/u*this.ticksPerStep)+v,N=e.payload[h%e.payload.length];this.pushPayloadAt(f,N)}}}pushPayloadAt(t,e){const s=(t%this.effectiveBarTicks+this.effectiveBarTicks)%this.effectiveBarTicks,a=this.schedule.get(s)??[];a.push(e),this.schedule.set(s,a)}static triggerAudio(t,e,s=100){const a=e+s/1e3;t.start(e),t.stop(a)}static triggerMidi(t,e,s,a,u=100){t.send([144,e,s],a),t.send([128,e,0],a+u)}static triggerStartStop(t,e,s,a){B.scheduleAt(s,t),a&&B.scheduleAt(a,t+e)}}async function H(){let l=null;const t=new AudioContext,e=new B({bpm:120,audioContext:t,ppqn:24}),s=[];if("requestMIDIAccess"in navigator){l=await navigator.requestMIDIAccess();for(const o of l.outputs.values())s.push(o)}const a=e.ppqn/24,u=Array.from(document.querySelectorAll(".beat-indicator")),S=30;function v(o){const n=t.createOscillator();n.type="sine",n.frequency.setValueAtTime(150,o),n.frequency.exponentialRampToValueAtTime(.001,o+.2);const r=t.createGain();r.gain.setValueAtTime(1,o),r.gain.exponentialRampToValueAtTime(.001,o+.2),n.connect(r).connect(t.destination),b.triggerAudio(n,o,200)}const T=(()=>{const o=t.createBuffer(1,t.sampleRate*.1,t.sampleRate),n=o.getChannelData(0);for(let r=0;r<n.length;r++)n[r]=Math.random()*2-1;return o})();function h(o){const n=t.createBufferSource();n.buffer=T;const r=t.createBiquadFilter();r.type="highpass",r.frequency.value=8e3;const f=t.createGain();f.gain.setValueAtTime(.3,o),f.gain.exponentialRampToValueAtTime(.001,o+.05),n.connect(r).connect(f).connect(t.destination),b.triggerAudio(n,o,50)}const d=document.getElementById("startStop");return d.onclick=async()=>{e.started?(e.stop(),d.textContent="Start"):(await t.resume(),await e.start(),d.textContent="Stop")},{audioCtx:t,clock:e,midiOutputs:s,midiAccess:l,midiInterval:a,indicators:u,swingMs:S,playKick:v,playHat:h}}(async()=>{let{audioCtx:l,clock:t,midiOutputs:e,midiAccess:s,midiInterval:a,indicators:u,swingMs:S,playKick:v,playHat:T}=await H(),h=a,d=e[0]??null;const o=document.getElementById("midiOut");e.forEach((i,c)=>{const m=document.createElement("option");m.value=c.toString(),m.text=i.name,o.appendChild(m)}),o.onchange=()=>{d=e[+o.value]},s&&(s.onstatechange=()=>{e=Array.from(s.outputs.values());const i=document.getElementById("midiOut");i.innerHTML="",e.forEach((c,m)=>{const y=document.createElement("option");y.value=m.toString(),y.text=c.name,i.appendChild(y)}),d=e[+i.value]??null});const n=Array.from({length:16},()=>new b(t,16)),r=document.getElementById("bpm");r.onchange=()=>{const i=+r.value;t.setBpm(i),n.forEach(c=>c.setBpm(i))};const f=document.getElementById("ppqn");f.onchange=()=>{const i=+f.value;t.setPpqn(i),n.forEach(c=>c.setPpqn(i)),h=i/24};const N=n[0],C=n[4],w=Array(16).fill(null),O=Array(16).fill(null);w[0]={payload:[{kind:"kick"}]};for(let i=0;i<15;i+=4)O[i]={payload:[{kind:"kick"}]};[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16].forEach((i,c)=>{w[i-1]={payload:[{kind:"hat"}],offsetMs:c%2?S:0}}),N.setSequence(w),C.setSequence(O);const V=n[1],x=Array(16).fill(null);x[2]={payload:[{freq:523.25}],offsetMs:10},x[6]={payload:[{freq:1046.5}],offsetMs:-420},V.setSequence(x);const D=n[2],M=Array(16).fill(null);M[0]={payload:[{freq:130.81*2},{freq:164.81*2},{freq:196*2},{freq:261.63*2}],subdivs:1},M[8]={payload:[{freq:130.81*2},{freq:164.81*2},{freq:196*2},{freq:261.63*2}],subdivs:2},M[12]={payload:[{freq:130.81*2},{freq:164.81*2},{freq:196*2},{freq:261.63*2}],subdivs:3},D.setSequence(M);const R=n[3],k=Array(16).fill(null);k[0]={payload:[{midiNote:60,velocity:127,durationMs:200},{midiNote:64,velocity:127,durationMs:200},{midiNote:67,velocity:127,durationMs:200},{midiNote:72,velocity:127,durationMs:200}],subdivs:0},k[3]={payload:[{midiNote:60,velocity:127,durationMs:200},{midiNote:64,velocity:127,durationMs:200},{midiNote:67,velocity:127,durationMs:200},{midiNote:72,velocity:127,durationMs:200}],subdivs:1},k[6]={payload:[{midiNote:60,velocity:127,durationMs:200},{midiNote:64,velocity:127,durationMs:200},{midiNote:67,velocity:127,durationMs:200},{midiNote:72,velocity:127,durationMs:200}],subdivs:0},k[9]={payload:[{midiNote:60,velocity:127,durationMs:200},{midiNote:64,velocity:127,durationMs:200},{midiNote:67,velocity:127,durationMs:200},{midiNote:72,velocity:127,durationMs:200}],subdivs:0},k[12]={payload:[{midiNote:60,velocity:127,durationMs:200},{midiNote:64,velocity:127,durationMs:200},{midiNote:67,velocity:127,durationMs:200},{midiNote:70,velocity:127,durationMs:200}],subdivs:0},R.setSequence(k),t.on("tick",i=>{if(d&&i.tick%h===0&&d.send([248],i.scheduledTimeMs),i.tick%(t.ppqn/4)===0){const c=i.tick/(t.ppqn/4)%u.length;B.scheduleAt(()=>{u.forEach((m,y)=>{m.style.opacity=y===c?"1":"0.2"})},i.scheduledTimeMs)}for(let c=0;c<16;c++){const y=n[c].getPayloadsForTick(i.tick);if(y.length!==0)for(const A of y){const q=i.audioTime;if(c===0||c===4)A.kind==="kick"?v(q):A.kind==="hat"&&T(q);else if(c===1||c===2){const{freq:E,durationMs:P=200}=A,g=l.createOscillator();g.type="sawtooth",g.frequency.setValueAtTime(E,q);const I=l.createGain();I.gain.setValueAtTime(.2,q),I.gain.exponentialRampToValueAtTime(.001,q+P/1e3),g.connect(I).connect(l.destination),b.triggerAudio(g,q,P)}if(c===3&&d){const{midiNote:E,velocity:P=127,durationMs:g=200}=A;b.triggerMidi(d,E,P,i.scheduledTimeMs,g)}}}})})();
