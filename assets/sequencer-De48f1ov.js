var R=Object.defineProperty;var N=(r,e,t)=>e in r?R(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var h=(r,e,t)=>N(r,typeof e!="symbol"?e+"":e,t);import{D as G}from"./deadon-C-GpHaav.js";class v{constructor(e,t=16,i,l){h(this,"sequence");h(this,"schedule",new Map);h(this,"barTicks");h(this,"effectiveBarTicks");h(this,"ticksPerStep");h(this,"secPerTick");h(this,"bpm",120);h(this,"ppqn",24);h(this,"speedFactor",1);h(this,"division",1);this.clock=e,this.steps=t,this.ppqn=i??e.ppqn,this.bpm=l??e.bpm,this.barTicks=this.ppqn*4,this.effectiveBarTicks=this.barTicks/this.speedFactor,this.secPerTick=60/(this.bpm*this.ppqn),this.ticksPerStep=this.effectiveBarTicks/this.steps,this.sequence=Array(this.steps).fill(null),this.rebuildSchedule()}setSequence(e){if(e.length!==this.steps)throw new Error(`Sequence length must be ${this.steps}`);this.sequence=e.slice(),this.rebuildSchedule()}setStep(e,t){if(e<0||e>=this.steps)throw new Error(`Step must be between 0 and ${this.steps-1}`);this.sequence[e]=t,this.rebuildSchedule()}clearSequence(){this.sequence.fill(null),this.rebuildSchedule()}setPpqn(e){this.ppqn=e,this.barTicks=this.ppqn*4,this.effectiveBarTicks=this.barTicks/this.speedFactor,this.ticksPerStep=this.effectiveBarTicks/this.steps,this.secPerTick=60/(this.bpm*this.ppqn),this.rebuildSchedule()}setBpm(e){this.bpm=e,this.secPerTick=60/(this.bpm*this.ppqn),this.effectiveBarTicks=this.barTicks/this.speedFactor,this.ticksPerStep=this.effectiveBarTicks/this.steps,this.rebuildSchedule()}setSpeedFactor(e){this.speedFactor=e>0?e:1,this.effectiveBarTicks=this.barTicks/this.speedFactor,this.ticksPerStep=this.effectiveBarTicks/this.steps,this.rebuildSchedule()}clearStep(e){this.setStep(e,null)}getPayloadsForTick(e){return this.schedule.get(e%this.effectiveBarTicks)??[]}rebuildSchedule(){this.schedule.clear();for(let e=0;e<this.steps;e++){const t=this.sequence[e];if(!t)continue;let i=(e+1)%this.steps;for(;i!==e&&!this.sequence[i];)i=(i+1)%this.steps;const l=i===e?this.steps:i>e?i-e:i+this.steps-e,p=t.subdivs??0,y=this.secPerTick*1e3,f=t.offsetTick!=null&&t.offsetTick>0?Math.round(t.offsetTick):t.offsetMs!=null?Math.round(t.offsetMs/y):0;if(p===0){const u=Math.floor(e*this.ticksPerStep)+f;for(const c of t.payload)this.pushPayloadAt(u,c);continue}const g=l*p;for(let d=0;d<g;d++){const u=Math.floor(d/p),c=d%p,n=(e+u)%this.steps,m=Math.floor(n*this.ticksPerStep)+Math.floor(c/p*this.ticksPerStep)+f,B=t.payload[d%t.payload.length];this.pushPayloadAt(m,B)}}}pushPayloadAt(e,t){const i=(e%this.effectiveBarTicks+this.effectiveBarTicks)%this.effectiveBarTicks,l=this.schedule.get(i)??[];l.push(t),this.schedule.set(i,l)}static triggerAudio(e,t,i=100){const l=t+i/1e3;e.start(t),e.stop(l)}static triggerMidi(e,t,i,l,p=100){const y=performance.now(),f=Math.max(l,y);e.send([144,t,i],f),e.send([128,t,0],p)}}async function H(){let r=null;const e=new AudioContext,t=new G({bpm:120,audioContext:e,ppqn:24}),i=[];if("requestMIDIAccess"in navigator){r=await navigator.requestMIDIAccess();for(const c of r.outputs.values())i.push(c)}const l=t.ppqn/24,p=Array.from(document.querySelectorAll(".beat-indicator")),y=30;function f(c){const n=e.createOscillator();n.type="sine",n.frequency.setValueAtTime(150,c),n.frequency.exponentialRampToValueAtTime(.001,c+.2);const a=e.createGain();a.gain.setValueAtTime(1,c),a.gain.exponentialRampToValueAtTime(.001,c+.2),n.connect(a).connect(e.destination),v.triggerAudio(n,c,200)}const g=(()=>{const c=e.createBuffer(1,e.sampleRate*.1,e.sampleRate),n=c.getChannelData(0);for(let a=0;a<n.length;a++)n[a]=Math.random()*2-1;return c})();function d(c){const n=e.createBufferSource();n.buffer=g;const a=e.createBiquadFilter();a.type="highpass",a.frequency.value=8e3;const m=e.createGain();m.gain.setValueAtTime(.3,c),m.gain.exponentialRampToValueAtTime(.001,c+.05),n.connect(a).connect(m).connect(e.destination),v.triggerAudio(n,c,50)}const u=document.getElementById("startStop");return u.onclick=async()=>{t.started?(t.stop(),u.textContent="Start"):(await e.resume(),await t.start(),u.textContent="Stop")},{audioCtx:e,clock:t,midiOutputs:i,midiAccess:r,midiInterval:l,indicators:p,swingMs:y,playKick:f,playHat:d}}(async()=>{let{audioCtx:r,clock:e,midiOutputs:t,midiAccess:i,midiInterval:l,indicators:p,swingMs:y,playKick:f,playHat:g}=await H(),d=l,u=t[0]??null;const c=document.getElementById("midiOut");t.forEach((s,o)=>{const k=document.createElement("option");k.value=o.toString(),k.text=s.name,c.appendChild(k)}),c.onchange=()=>{u=t[+c.value]},i&&(i.onstatechange=()=>{t=Array.from(i.outputs.values());const s=document.getElementById("midiOut");s.innerHTML="",t.forEach((o,k)=>{const q=document.createElement("option");q.value=k.toString(),q.text=o.name,s.appendChild(q)}),u=t[+s.value]??null});const n=Array.from({length:16},()=>new v(e,16)),a=document.getElementById("bpm");a.onchange=()=>{const s=+a.value;e.setBpm(s),n.forEach(o=>o.setBpm(s))};const m=document.getElementById("ppqn");m.onchange=()=>{const s=+m.value;e.setPpqn(s),n.forEach(o=>o.setPpqn(s)),d=s/24};const B=n[0],F=n[4],w=Array(16).fill(null),C=Array(16).fill(null);w[0]={payload:[{kind:"kick"}]};for(let s=0;s<15;s+=4)C[s]={payload:[{kind:"kick"}]};[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16].forEach((s,o)=>{w[s-1]={payload:[{kind:"hat"}],offsetMs:o%2?y:0}}),B.setSequence(w),F.setSequence(C);const O=n[1],x=Array(16).fill(null);x[2]={payload:[{freq:523.25}],offsetMs:10},x[6]={payload:[{freq:1046.5}],offsetMs:-420},O.setSequence(x);const V=n[2],M=Array(16).fill(null);M[0]={payload:[{freq:130.81*2},{freq:164.81*2},{freq:196*2},{freq:261.63*2}],subdivs:1},M[8]={payload:[{freq:130.81*2},{freq:164.81*2},{freq:196*2},{freq:261.63*2}],subdivs:2},M[12]={payload:[{freq:130.81*2},{freq:164.81*2},{freq:196*2},{freq:261.63*2}],subdivs:3},V.setSequence(M);const D=n[3],b=Array(16).fill(null);b[0]={payload:[{midiNote:60,velocity:127,durationMs:200}],subdivs:0},b[4]={payload:[{midiNote:60,velocity:127,durationMs:200}],subdivs:0},b[8]={payload:[{midiNote:60,velocity:127,durationMs:200}],subdivs:0},b[12]={payload:[{midiNote:60,velocity:127,durationMs:200}],subdivs:0},D.setSequence(b),e.on("tick",s=>{if(u&&s.tick%d===0&&u.send([248],s.timeMs),s.tick%(e.ppqn/4)===0){const o=s.tick/(e.ppqn/4)%p.length;e.scheduleAt(()=>{p.forEach((k,q)=>{k.style.opacity=q===o?"1":"0.2"})},s.timeMs)}for(let o=0;o<16;o++){const q=n[o].getPayloadsForTick(s.tick);if(q.length!==0)for(const A of q){const T=s.audioTime;if(o===0||o===4)A.kind==="kick"?f(T):A.kind==="hat"&&g(T);else if(o===1||o===2){const{freq:E,durationMs:P=200}=A,S=r.createOscillator();S.type="sawtooth",S.frequency.setValueAtTime(E,T);const I=r.createGain();I.gain.setValueAtTime(.2,T),I.gain.exponentialRampToValueAtTime(.001,T+P/1e3),S.connect(I).connect(r.destination),v.triggerAudio(S,T,P)}if(o===3&&u){const{midiNote:E,velocity:P=127,durationMs:S=200}=A;v.triggerMidi(u,E,P,s.timeMs,s.timeMs+S)}}}})})();
