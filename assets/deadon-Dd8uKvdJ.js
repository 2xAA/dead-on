var I=Object.defineProperty;var n=(g,e,t)=>e in g?I(g,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):g[e]=t;var o=(g,e,t)=>n(g,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))d(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&d(r)}).observe(document,{childList:!0,subtree:!0});function t(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function d(i){if(i.ep)return;i.ep=!0;const s=t(i);fetch(i.href,s)}})();const l="data:video/mp2t;base64,Y2xhc3MgU2NoZWR1bGVyUHJvY2Vzc29yIGV4dGVuZHMgQXVkaW9Xb3JrbGV0UHJvY2Vzc29yIHsKICBicG06IG51bWJlcjsKICBwcHFuOiBudW1iZXI7CiAgY3VycmVudFNhbXBsZTogbnVtYmVyOwogIHRpY2tDb3VudDogbnVtYmVyOwogIHN0YXJ0VGltZU1zOiBudW1iZXI7CgogIGdldCB0aWNrSW50ZXJ2YWxTZWMoKSB7CiAgICByZXR1cm4gNjAgLyAodGhpcy5icG0gKiB0aGlzLnBwcW4pOwogIH0KCiAgZ2V0IHNhbXBsZXNQZXJUaWNrKCkgewogICAgcmV0dXJuIHRoaXMudGlja0ludGVydmFsU2VjICogc2FtcGxlUmF0ZTsKICB9CgogIGNvbnN0cnVjdG9yKG9wdGlvbnM6IHsgcHJvY2Vzc29yT3B0aW9uczogeyBicG0/OiBudW1iZXI7IHBwcW4/OiBudW1iZXIgfSB9KSB7CiAgICBzdXBlcigpOwogICAgdGhpcy5icG0gPSBvcHRpb25zLnByb2Nlc3Nvck9wdGlvbnMuYnBtIHx8IDEyMDsKICAgIHRoaXMucHBxbiA9IG9wdGlvbnMucHJvY2Vzc29yT3B0aW9ucy5wcHFuIHx8IDI0OwogICAgdGhpcy5jdXJyZW50U2FtcGxlID0gMDsKICAgIHRoaXMudGlja0NvdW50ID0gMDsKICAgIHRoaXMuc3RhcnRUaW1lTXMgPSAwOwoKICAgIHRoaXMucG9ydC5vbm1lc3NhZ2UgPSAoZXZlbnQpID0+IHsKICAgICAgaWYgKGV2ZW50LmRhdGEgJiYgZXZlbnQuZGF0YS50eXBlID09PSAidXBkYXRlQlBNIikgewogICAgICAgIHRoaXMuYnBtID0gZXZlbnQuZGF0YS5icG07CiAgICAgICAgLy8gSWYgYSBuZXcgdGltZSBvcmlnaW4gaXMgcHJvdmlkZWQsIHJlc2V0IHRvIGl0CiAgICAgICAgaWYgKGV2ZW50LmRhdGEudGltZSAhPSBudWxsKSB7CiAgICAgICAgICB0aGlzLnN0YXJ0VGltZU1zID0gZXZlbnQuZGF0YS50aW1lOwogICAgICAgIH0KICAgICAgICB0aGlzLnRpY2tDb3VudCA9IDA7CiAgICAgICAgdGhpcy5jdXJyZW50U2FtcGxlID0gMDsKICAgICAgfSBlbHNlIGlmIChldmVudC5kYXRhICYmIGV2ZW50LmRhdGEudHlwZSA9PT0gInVwZGF0ZVBQUU4iKSB7CiAgICAgICAgdGhpcy5wcHFuID0gZXZlbnQuZGF0YS5wcHFuOwogICAgICAgIC8vIElmIGEgbmV3IHRpbWUgb3JpZ2luIGlzIHByb3ZpZGVkLCByZXNldCB0byBpdAogICAgICAgIGlmIChldmVudC5kYXRhLnRpbWUgIT0gbnVsbCkgewogICAgICAgICAgdGhpcy5zdGFydFRpbWVNcyA9IGV2ZW50LmRhdGEudGltZTsKICAgICAgICB9CiAgICAgICAgdGhpcy50aWNrQ291bnQgPSAwOwogICAgICAgIHRoaXMuY3VycmVudFNhbXBsZSA9IDA7CiAgICAgIH0gZWxzZSBpZiAoZXZlbnQuZGF0YSAmJiBldmVudC5kYXRhLnR5cGUgPT09ICJzdGFydCIpIHsKICAgICAgICB0aGlzLnN0YXJ0VGltZU1zID0gZXZlbnQuZGF0YS50aW1lOwogICAgICAgIHRoaXMudGlja0NvdW50ID0gMDsKICAgICAgICB0aGlzLmN1cnJlbnRTYW1wbGUgPSAwOwogICAgICB9CiAgICB9OwogIH0KCiAgcHJvY2VzcyhfaW5wdXRzOiBGbG9hdDMyQXJyYXlbXVtdLCBvdXRwdXRzOiBGbG9hdDMyQXJyYXlbXVtdKTogYm9vbGVhbiB7CiAgICBjb25zdCBibG9ja1NpemU6IG51bWJlciA9IG91dHB1dHNbMF0/LlswXT8ubGVuZ3RoIHx8IDEyODsKICAgIHRoaXMuY3VycmVudFNhbXBsZSArPSBibG9ja1NpemU7CgogICAgd2hpbGUgKHRoaXMuY3VycmVudFNhbXBsZSA+PSB0aGlzLnNhbXBsZXNQZXJUaWNrKSB7CiAgICAgIHRoaXMuY3VycmVudFNhbXBsZSAtPSB0aGlzLnNhbXBsZXNQZXJUaWNrOwoKICAgICAgY29uc3Qgc2NoZWR1bGVkVGltZTogbnVtYmVyID0KICAgICAgICB0aGlzLnN0YXJ0VGltZU1zICsgdGhpcy50aWNrQ291bnQgKiB0aGlzLnRpY2tJbnRlcnZhbFNlYyAqIDEwMDA7CgogICAgICB0aGlzLnBvcnQucG9zdE1lc3NhZ2UoeyB0eXBlOiAidGljayIsIHNjaGVkdWxlZFRpbWUgfSk7CiAgICAgIHRoaXMudGlja0NvdW50Kys7CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9Cn0KCnJlZ2lzdGVyUHJvY2Vzc29yKCJzY2hlZHVsZXItcHJvY2Vzc29yIiwgU2NoZWR1bGVyUHJvY2Vzc29yKTsK";let c=!1;async function u(g){c||(await g.audioWorklet.addModule(l),c=!0)}class a{constructor(e){o(this,"_bpm");o(this,"ctx");o(this,"_ppqn");o(this,"schedulerNode",null);o(this,"tickCount",0);o(this,"_started",!1);o(this,"listeners",{tick:new Set});o(this,"timeOriginPerfNow",0);o(this,"timeOriginAudioTime",0);this._bpm=e.bpm,this.ctx=e.audioContext??new AudioContext,this._ppqn=e.ppqn??24}get started(){return this._started}get ppqn(){return this._ppqn}get bpm(){return this._bpm}async setupWorklet(){await u(this.ctx),this.schedulerNode=new AudioWorkletNode(this.ctx,"scheduler-processor",{processorOptions:{bpm:this.bpm,ppqn:this.ppqn}})}async start(){this.started||(this.schedulerNode||await this.setupWorklet(),this.tickCount=0,this.timeOriginPerfNow=performance.now(),this.timeOriginAudioTime=this.ctx.currentTime,this.schedulerNode.port.postMessage({type:"start",time:this.timeOriginPerfNow}),this.schedulerNode.port.onmessage=e=>{e.data.type==="tick"&&this.handleTick(e.data.scheduledTime)},this.schedulerNode.connect(this.ctx.destination),this._started=!0)}stop(){this.schedulerNode&&(this.schedulerNode.disconnect(),this.schedulerNode.port.onmessage=null,this.schedulerNode=null),this._started=!1}setBpm(e){var t;this._bpm=e,this.timeOriginPerfNow=performance.now(),this.timeOriginAudioTime=this.ctx.currentTime,(t=this.schedulerNode)==null||t.port.postMessage({type:"updateBPM",bpm:e,time:this.timeOriginPerfNow})}setPpqn(e){var t;this._ppqn=e,this.timeOriginPerfNow=performance.now(),this.timeOriginAudioTime=this.ctx.currentTime,(t=this.schedulerNode)==null||t.port.postMessage({type:"updatePPQN",ppqn:e,time:this.timeOriginPerfNow})}on(e,t){this.listeners[e].add(t)}off(e,t){this.listeners[e].delete(t)}handleTick(e){const t={scheduledTimeMs:e,audioTime:this.wallToAudioTime(e),tick:this.tickCount,bpm:this.bpm};this.tickCount++;for(const d of this.listeners.tick)d(t)}wallToAudioTime(e){return this.timeOriginAudioTime+(e-this.timeOriginPerfNow)/1e3}audioToWallTime(e){return this.timeOriginPerfNow+(e-this.timeOriginAudioTime)*1e3}static scheduleAt(e,t){const d=t-performance.now();d>0?setTimeout(e,d):e()}}export{a as D};
