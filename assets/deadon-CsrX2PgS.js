var r=Object.defineProperty;var l=(o,e,t)=>e in o?r(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var g=(o,e,t)=>l(o,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))I(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const d of s.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&I(d)}).observe(document,{childList:!0,subtree:!0});function t(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function I(i){if(i.ep)return;i.ep=!0;const s=t(i);fetch(i.href,s)}})();const n="data:application/javascript;base64,dmFyIF9fZGVmUHJvcCA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eTsKdmFyIF9fZGVmTm9ybWFsUHJvcCA9IChvYmosIGtleSwgdmFsdWUpID0+IGtleSBpbiBvYmogPyBfX2RlZlByb3Aob2JqLCBrZXksIHsgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSwgdmFsdWUgfSkgOiBvYmpba2V5XSA9IHZhbHVlOwp2YXIgX19wdWJsaWNGaWVsZCA9IChvYmosIGtleSwgdmFsdWUpID0+IF9fZGVmTm9ybWFsUHJvcChvYmosIHR5cGVvZiBrZXkgIT09ICJzeW1ib2wiID8ga2V5ICsgIiIgOiBrZXksIHZhbHVlKTsKY2xhc3MgU2NoZWR1bGVyUHJvY2Vzc29yIGV4dGVuZHMgQXVkaW9Xb3JrbGV0UHJvY2Vzc29yIHsKICBjb25zdHJ1Y3RvcihvcHRpb25zKSB7CiAgICBzdXBlcigpOwogICAgX19wdWJsaWNGaWVsZCh0aGlzLCAiYnBtIik7CiAgICBfX3B1YmxpY0ZpZWxkKHRoaXMsICJwcHFuIik7CiAgICBfX3B1YmxpY0ZpZWxkKHRoaXMsICJjdXJyZW50U2FtcGxlIik7CiAgICBfX3B1YmxpY0ZpZWxkKHRoaXMsICJ0aWNrQ291bnQiKTsKICAgIF9fcHVibGljRmllbGQodGhpcywgInN0YXJ0VGltZU1zIik7CiAgICB0aGlzLmJwbSA9IG9wdGlvbnMucHJvY2Vzc29yT3B0aW9ucy5icG0gfHwgMTIwOwogICAgdGhpcy5wcHFuID0gb3B0aW9ucy5wcm9jZXNzb3JPcHRpb25zLnBwcW4gfHwgMjQ7CiAgICB0aGlzLmN1cnJlbnRTYW1wbGUgPSAwOwogICAgdGhpcy50aWNrQ291bnQgPSAwOwogICAgdGhpcy5zdGFydFRpbWVNcyA9IDA7CiAgICB0aGlzLnBvcnQub25tZXNzYWdlID0gKGV2ZW50KSA9PiB7CiAgICAgIGlmIChldmVudC5kYXRhICYmIGV2ZW50LmRhdGEudHlwZSA9PT0gInVwZGF0ZUJQTSIpIHsKICAgICAgICB0aGlzLmJwbSA9IGV2ZW50LmRhdGEuYnBtOwogICAgICAgIGlmIChldmVudC5kYXRhLnRpbWUgIT0gbnVsbCkgewogICAgICAgICAgdGhpcy5zdGFydFRpbWVNcyA9IGV2ZW50LmRhdGEudGltZTsKICAgICAgICB9CiAgICAgICAgdGhpcy50aWNrQ291bnQgPSAwOwogICAgICAgIHRoaXMuY3VycmVudFNhbXBsZSA9IDA7CiAgICAgIH0gZWxzZSBpZiAoZXZlbnQuZGF0YSAmJiBldmVudC5kYXRhLnR5cGUgPT09ICJ1cGRhdGVQUFFOIikgewogICAgICAgIHRoaXMucHBxbiA9IGV2ZW50LmRhdGEucHBxbjsKICAgICAgICBpZiAoZXZlbnQuZGF0YS50aW1lICE9IG51bGwpIHsKICAgICAgICAgIHRoaXMuc3RhcnRUaW1lTXMgPSBldmVudC5kYXRhLnRpbWU7CiAgICAgICAgfQogICAgICAgIHRoaXMudGlja0NvdW50ID0gMDsKICAgICAgICB0aGlzLmN1cnJlbnRTYW1wbGUgPSAwOwogICAgICB9IGVsc2UgaWYgKGV2ZW50LmRhdGEgJiYgZXZlbnQuZGF0YS50eXBlID09PSAic3RhcnQiKSB7CiAgICAgICAgdGhpcy5zdGFydFRpbWVNcyA9IGV2ZW50LmRhdGEudGltZTsKICAgICAgICB0aGlzLnRpY2tDb3VudCA9IDA7CiAgICAgICAgdGhpcy5jdXJyZW50U2FtcGxlID0gMDsKICAgICAgfQogICAgfTsKICB9CiAgZ2V0IHRpY2tJbnRlcnZhbFNlYygpIHsKICAgIHJldHVybiA2MCAvICh0aGlzLmJwbSAqIHRoaXMucHBxbik7CiAgfQogIGdldCBzYW1wbGVzUGVyVGljaygpIHsKICAgIHJldHVybiB0aGlzLnRpY2tJbnRlcnZhbFNlYyAqIHNhbXBsZVJhdGU7CiAgfQogIHByb2Nlc3MoX2lucHV0cywgb3V0cHV0cykgewogICAgdmFyIF9hLCBfYjsKICAgIGNvbnN0IGJsb2NrU2l6ZSA9ICgoX2IgPSAoX2EgPSBvdXRwdXRzWzBdKSA9PSBudWxsID8gdm9pZCAwIDogX2FbMF0pID09IG51bGwgPyB2b2lkIDAgOiBfYi5sZW5ndGgpIHx8IDEyODsKICAgIHRoaXMuY3VycmVudFNhbXBsZSArPSBibG9ja1NpemU7CiAgICB3aGlsZSAodGhpcy5jdXJyZW50U2FtcGxlID49IHRoaXMuc2FtcGxlc1BlclRpY2spIHsKICAgICAgdGhpcy5jdXJyZW50U2FtcGxlIC09IHRoaXMuc2FtcGxlc1BlclRpY2s7CiAgICAgIGNvbnN0IHNjaGVkdWxlZFRpbWUgPSB0aGlzLnN0YXJ0VGltZU1zICsgdGhpcy50aWNrQ291bnQgKiB0aGlzLnRpY2tJbnRlcnZhbFNlYyAqIDFlMzsKICAgICAgdGhpcy5wb3J0LnBvc3RNZXNzYWdlKHsgdHlwZTogInRpY2siLCBzY2hlZHVsZWRUaW1lIH0pOwogICAgICB0aGlzLnRpY2tDb3VudCsrOwogICAgfQogICAgcmV0dXJuIHRydWU7CiAgfQp9CnJlZ2lzdGVyUHJvY2Vzc29yKCJzY2hlZHVsZXItcHJvY2Vzc29yIiwgU2NoZWR1bGVyUHJvY2Vzc29yKTsK";let c=!1;async function C(o){c||(await o.audioWorklet.addModule(n),c=!0)}class h{constructor(e){g(this,"_bpm");g(this,"ctx");g(this,"_ppqn");g(this,"schedulerNode",null);g(this,"tickCount",0);g(this,"_started",!1);g(this,"listeners",{tick:new Set});g(this,"timeOriginPerfNow",0);g(this,"timeOriginAudioTime",0);this._bpm=e.bpm,this.ctx=e.audioContext??new AudioContext,this._ppqn=e.ppqn??24}get started(){return this._started}get ppqn(){return this._ppqn}get bpm(){return this._bpm}async setupWorklet(){await C(this.ctx),this.schedulerNode=new AudioWorkletNode(this.ctx,"scheduler-processor",{processorOptions:{bpm:this.bpm,ppqn:this.ppqn}})}async start(){this.started||(this.schedulerNode||await this.setupWorklet(),this.tickCount=0,this.timeOriginPerfNow=performance.now(),this.timeOriginAudioTime=this.ctx.currentTime,this.schedulerNode.port.postMessage({type:"start",time:this.timeOriginPerfNow}),this.schedulerNode.port.onmessage=e=>{e.data.type==="tick"&&this.handleTick(e.data.scheduledTime)},this.schedulerNode.connect(this.ctx.destination),this._started=!0)}stop(){this.schedulerNode&&(this.schedulerNode.disconnect(),this.schedulerNode.port.onmessage=null,this.schedulerNode=null),this._started=!1}setBpm(e){var t;this._bpm=e,this.timeOriginPerfNow=performance.now(),this.timeOriginAudioTime=this.ctx.currentTime,(t=this.schedulerNode)==null||t.port.postMessage({type:"updateBPM",bpm:e,time:this.timeOriginPerfNow})}setPpqn(e){var t;this._ppqn=e,this.timeOriginPerfNow=performance.now(),this.timeOriginAudioTime=this.ctx.currentTime,(t=this.schedulerNode)==null||t.port.postMessage({type:"updatePPQN",ppqn:e,time:this.timeOriginPerfNow})}on(e,t){this.listeners[e].add(t)}off(e,t){this.listeners[e].delete(t)}handleTick(e){const t={scheduledTimeMs:e,audioTime:this.wallToAudioTime(e),tick:this.tickCount,bpm:this.bpm};this.tickCount++;for(const I of this.listeners.tick)I(t)}wallToAudioTime(e){return this.timeOriginAudioTime+(e-this.timeOriginPerfNow)/1e3}audioToWallTime(e){return this.timeOriginPerfNow+(e-this.timeOriginAudioTime)*1e3}static scheduleAt(e,t){const I=t-performance.now();I>0?setTimeout(e,I):e()}}export{h as D};
