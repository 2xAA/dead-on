var N=Object.defineProperty;var F=(r,t,e)=>t in r?N(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var d=(r,t,e)=>F(r,typeof t!="symbol"?t+"":t,e);import{D as G}from"./deadon-C-GpHaav.js";class b{constructor(t,e=16,i,l){d(this,"sequence");d(this,"schedule",new Map);d(this,"barTicks");d(this,"effectiveBarTicks");d(this,"ticksPerStep");d(this,"secPerTick");d(this,"bpm",120);d(this,"ppqn",24);d(this,"division",1);this.clock=t,this.steps=e,this.ppqn=i??t.ppqn,this.bpm=l??t.bpm,this.barTicks=this.ppqn*4,this.effectiveBarTicks=this.barTicks/this.division,this.secPerTick=60/(this.bpm*this.ppqn),this.ticksPerStep=this.effectiveBarTicks/this.steps,this.sequence=Array(this.steps).fill(null),this.rebuildSchedule()}setSequence(t){if(t.length!==this.steps)throw new Error(`Sequence length must be ${this.steps}`);this.sequence=t.slice(),this.rebuildSchedule()}setStep(t,e){if(t<0||t>=this.steps)throw new Error(`Step must be between 0 and ${this.steps-1}`);this.sequence[t]=e,this.rebuildSchedule()}clearSequence(){this.sequence.fill(null),this.rebuildSchedule()}setPpqn(t){this.ppqn=t,this.barTicks=this.ppqn*4,this.effectiveBarTicks=this.barTicks/this.division,this.ticksPerStep=this.effectiveBarTicks/this.steps,this.secPerTick=60/(this.bpm*this.ppqn),this.rebuildSchedule()}setBpm(t){this.bpm=t,this.secPerTick=60/(this.bpm*this.ppqn),this.effectiveBarTicks=this.barTicks/this.division,this.ticksPerStep=this.effectiveBarTicks/this.steps,this.rebuildSchedule()}setDivision(t){this.division=Math.max(1,Math.floor(t)),this.effectiveBarTicks=this.barTicks/this.division,this.ticksPerStep=this.effectiveBarTicks/this.steps,this.rebuildSchedule()}clearStep(t){this.setStep(t,null)}getPayloadsForTick(t){return this.schedule.get(t%this.effectiveBarTicks)??[]}rebuildSchedule(){this.schedule.clear();for(let t=0;t<this.steps;t++){const e=this.sequence[t];if(!e)continue;let i=(t+1)%this.steps;for(;i!==t&&!this.sequence[i];)i=(i+1)%this.steps;const l=i===t?this.steps:i>t?i-t:i+this.steps-t,p=e.subdivs??0,y=this.secPerTick*1e3,f=e.offsetMs!=null?Math.round(e.offsetMs/y):0;if(p===0){const u=Math.floor(t*this.ticksPerStep)+f;for(const c of e.payload)this.pushPayloadAt(u,c);continue}const g=l*p;for(let h=0;h<g;h++){const u=Math.floor(h/p),c=h%p,n=(t+u)%this.steps,m=Math.floor(n*this.ticksPerStep)+Math.floor(c/p*this.ticksPerStep)+f,B=e.payload[h%e.payload.length];this.pushPayloadAt(m,B)}}}pushPayloadAt(t,e){const i=(t%this.effectiveBarTicks+this.effectiveBarTicks)%this.effectiveBarTicks,l=this.schedule.get(i)??[];l.push(e),this.schedule.set(i,l)}static triggerAudio(t,e,i=100){const l=e+i/1e3;t.start(e),t.stop(l)}static triggerMidi(t,e,i,l,p=100){const y=performance.now(),f=Math.max(l,y);t.send([144,e,i],f),t.send([128,e,0],p)}}async function H(){let r=null;const t=new AudioContext,e=new G({bpm:120,audioContext:t,ppqn:24}),i=[];if("requestMIDIAccess"in navigator){r=await navigator.requestMIDIAccess();for(const c of r.outputs.values())i.push(c)}const l=e.ppqn/24,p=Array.from(document.querySelectorAll(".beat-indicator")),y=30;function f(c){const n=t.createOscillator();n.type="sine",n.frequency.setValueAtTime(150,c),n.frequency.exponentialRampToValueAtTime(.001,c+.2);const a=t.createGain();a.gain.setValueAtTime(1,c),a.gain.exponentialRampToValueAtTime(.001,c+.2),n.connect(a).connect(t.destination),b.triggerAudio(n,c,200)}const g=(()=>{const c=t.createBuffer(1,t.sampleRate*.1,t.sampleRate),n=c.getChannelData(0);for(let a=0;a<n.length;a++)n[a]=Math.random()*2-1;return c})();function h(c){const n=t.createBufferSource();n.buffer=g;const a=t.createBiquadFilter();a.type="highpass",a.frequency.value=8e3;const m=t.createGain();m.gain.setValueAtTime(.3,c),m.gain.exponentialRampToValueAtTime(.001,c+.05),n.connect(a).connect(m).connect(t.destination),b.triggerAudio(n,c,50)}const u=document.getElementById("startStop");return u.onclick=async()=>{e.started?(e.stop(),u.textContent="Start"):(await t.resume(),await e.start(),u.textContent="Stop")},{audioCtx:t,clock:e,midiOutputs:i,midiAccess:r,midiInterval:l,indicators:p,swingMs:y,playKick:f,playHat:h}}(async()=>{let{audioCtx:r,clock:t,midiOutputs:e,midiAccess:i,midiInterval:l,indicators:p,swingMs:y,playKick:f,playHat:g}=await H(),h=l,u=e[0]??null;const c=document.getElementById("midiOut");e.forEach((s,o)=>{const k=document.createElement("option");k.value=o.toString(),k.text=s.name,c.appendChild(k)}),c.onchange=()=>{u=e[+c.value]},i&&(i.onstatechange=()=>{e=Array.from(i.outputs.values());const s=document.getElementById("midiOut");s.innerHTML="",e.forEach((o,k)=>{const q=document.createElement("option");q.value=k.toString(),q.text=o.name,s.appendChild(q)}),u=e[+s.value]??null});const n=Array.from({length:16},()=>new b(t,16)),a=document.getElementById("bpm");a.onchange=()=>{const s=+a.value;t.setBpm(s),n.forEach(o=>o.setBpm(s))};const m=document.getElementById("ppqn");m.onchange=()=>{const s=+m.value;t.setPpqn(s),n.forEach(o=>o.setPpqn(s)),h=s/24};const B=n[0],O=n[4],w=Array(16).fill(null),C=Array(16).fill(null);w[0]={payload:[{kind:"kick"}]};for(let s=0;s<15;s+=4)C[s]={payload:[{kind:"kick"}]};[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16].forEach((s,o)=>{w[s-1]={payload:[{kind:"hat"}],offsetMs:o%2?y:0}}),B.setSequence(w),O.setSequence(C);const V=n[1],x=Array(16).fill(null);x[2]={payload:[{freq:523.25}],offsetMs:10},x[6]={payload:[{freq:1046.5}],offsetMs:-420},V.setSequence(x);const D=n[2],M=Array(16).fill(null);M[0]={payload:[{freq:130.81*2},{freq:164.81*2},{freq:196*2},{freq:261.63*2}],subdivs:1},M[8]={payload:[{freq:130.81*2},{freq:164.81*2},{freq:196*2},{freq:261.63*2}],subdivs:2},M[12]={payload:[{freq:130.81*2},{freq:164.81*2},{freq:196*2},{freq:261.63*2}],subdivs:3},D.setSequence(M);const R=n[3],S=Array(16).fill(null);S[0]={payload:[{midiNote:60,velocity:127,durationMs:200}],subdivs:0},S[4]={payload:[{midiNote:60,velocity:127,durationMs:200}],subdivs:0},S[8]={payload:[{midiNote:60,velocity:127,durationMs:200}],subdivs:0},S[12]={payload:[{midiNote:60,velocity:127,durationMs:200}],subdivs:0},R.setSequence(S),t.on("tick",s=>{if(u&&s.tick%h===0&&u.send([248],s.timeMs),s.tick%(t.ppqn/4)===0){const o=s.tick/(t.ppqn/4)%p.length;t.scheduleAt(()=>{p.forEach((k,q)=>{k.style.opacity=q===o?"1":"0.2"})},s.timeMs)}for(let o=0;o<16;o++){const q=n[o].getPayloadsForTick(s.tick);if(q.length!==0)for(const A of q){const v=s.audioTime;if(o===0||o===4)A.kind==="kick"?f(v):A.kind==="hat"&&g(v);else if(o===1||o===2){const{freq:E,durationMs:P=200}=A,T=r.createOscillator();T.type="sawtooth",T.frequency.setValueAtTime(E,v);const I=r.createGain();I.gain.setValueAtTime(.2,v),I.gain.exponentialRampToValueAtTime(.001,v+P/1e3),T.connect(I).connect(r.destination),b.triggerAudio(T,v,P)}if(o===3&&u){const{midiNote:E,velocity:P=127,durationMs:T=200}=A;b.triggerMidi(u,E,P,s.timeMs,s.timeMs+T)}}}})})();
